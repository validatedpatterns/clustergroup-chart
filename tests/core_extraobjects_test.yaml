suite: Test extraObjects with various configurations
templates:
  - templates/core/extraObjects.yaml
release:
  name: release-test
tests:
  - it: should output nothing by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should render extra objects when defined
    set:
      clusterGroup:
        extraObjects:
          wait-for-storage:
            apiVersion: batch/v1
            kind: Job
            metadata:
              name: wait-for-storage
              annotations:
                argocd.argoproj.io/hook: Sync
                argocd.argoproj.io/sync-wave: "5"
            spec:
              template:
                spec:
                  restartPolicy: OnFailure
                  containers:
                    - name: wait
                      image: quay.io/validatedpatterns/imperative-container:v1
                      command: ["/bin/bash"]
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Job
      - equal:
          path: metadata.name
          value: wait-for-storage
      - equal:
          path: metadata.annotations["argocd.argoproj.io/hook"]
          value: Sync

  - it: should skip disabled extra objects
    set:
      clusterGroup:
        extraObjects:
          enabled-object:
            apiVersion: v1
            kind: ConfigMap
            metadata:
              name: enabled-cm
          disabled-object:
            disabled: true
            apiVersion: v1
            kind: ConfigMap
            metadata:
              name: disabled-cm
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: enabled-cm

  - it: should render multiple extra objects
    set:
      clusterGroup:
        extraObjects:
          configmap-1:
            apiVersion: v1
            kind: ConfigMap
            metadata:
              name: cm-1
            data:
              key: value1
          secret-1:
            apiVersion: v1
            kind: Secret
            metadata:
              name: secret-1
            type: Opaque
            data:
              password: dGVzdA==
    asserts:
      - hasDocuments:
          count: 2
      - documentSelector:
          path: kind
          value: ConfigMap
        equal:
          path: metadata.name
          value: cm-1
      - documentSelector:
          path: kind
          value: Secret
        equal:
          path: metadata.name
          value: secret-1
