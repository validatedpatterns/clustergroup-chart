suite: Test operatorgroup with various configurations
templates:
  - templates/core/operatorgroup.yaml
release:
  name: release-test
tests:
  - it: should output nothing by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should create operator groups for string list namespaces
    set:
      clusterGroup:
        namespaces:
          - openshift-operators
          - my-namespace
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: OperatorGroup

  - it: should create operator groups for map-based namespaces
    set:
      clusterGroup:
        namespaces:
          openshift-operators:
          my-namespace:
            operatorGroup: true
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: OperatorGroup

  - it: should skip namespaces with operatorGroup set to false
    set:
      clusterGroup:
        namespaces:
          enabled-namespace:
            operatorGroup: true
          disabled-namespace:
            operatorGroup: false
    asserts:
      - hasDocuments:
          count: 1

  - it: should respect operatorgroupExcludes
    set:
      clusterGroup:
        namespaces:
          - openshift-operators
          - excluded-namespace
          - included-namespace
        operatorgroupExcludes:
          - excluded-namespace
    asserts:
      - hasDocuments:
          count: 2

  - it: should handle custom targetNamespaces
    set:
      clusterGroup:
        namespaces:
          multi-target-ns:
            targetNamespaces:
              - target-ns-1
              - target-ns-2
              - target-ns-3
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: multi-target-ns-operator-group
      - equal:
          path: spec.targetNamespaces[0]
          value: target-ns-1
      - equal:
          path: spec.targetNamespaces[1]
          value: target-ns-2
      - equal:
          path: spec.targetNamespaces[2]
          value: target-ns-3

  - it: should skip operator groups for disabled namespaces
    set:
      clusterGroup:
        namespaces:
          - enabled-string-namespace
          - enabled-map-namespace:
              disabled: false
              labels:
                test: "enabled"
          - disabled-map-namespace:
              disabled: true
              labels:
                test: "disabled"
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: OperatorGroup
      - equal:
          path: metadata.name
          value: enabled-string-namespace-operator-group
        documentIndex: 0
      - equal:
          path: metadata.name
          value: enabled-map-namespace-operator-group
        documentIndex: 1

  - it: should handle mixed disabled and operatorGroup false configurations
    set:
      clusterGroup:
        namespaces:
          - enabled-namespace
          - disabled-namespace:
              disabled: true
          - no-operator-group-namespace:
              operatorGroup: false
              labels:
                test: "no-og"
          - enabled-with-og-namespace:
              disabled: false
              operatorGroup: true
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.name
          value: enabled-namespace-operator-group
        documentIndex: 0
      - equal:
          path: metadata.name
          value: enabled-with-og-namespace-operator-group
        documentIndex: 1
