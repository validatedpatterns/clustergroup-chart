suite: Test clustergroup git parameters propagation
templates:
  - templates/plumbing/applications.yaml
release:
  name: release-test
tests:
  - it: should not include clustergroup git params when not set
    set:
      global:
        repoURL: https://github.com/validatedpatterns/multicloud-gitops
        multiSourceRepoUrl: https://charts.validatedpatterns.io
      clusterGroup:
        applications:
          acm:
            name: acm
            namespace: open-cluster-management
            project: hub
            chart: acm
            chartVersion: 0.1.*
    asserts:
      - isKind:
          of: Application
      - hasDocuments:
          count: 1
      - documentSelector:
          path: metadata.name
          value: acm
        lengthEqual:
          path: spec.sources[1].helm.parameters
          count: 15

  - it: should include clusterGroupGitRepoUrl when set
    set:
      global:
        repoURL: https://github.com/validatedpatterns/multicloud-gitops
        multiSourceRepoUrl: https://charts.validatedpatterns.io
        clusterGroupGitRepoUrl: https://github.com/validatedpatterns/clustergroup-chart
      clusterGroup:
        applications:
          acm:
            name: acm
            namespace: open-cluster-management
            project: hub
            chart: acm
            chartVersion: 0.1.*
    asserts:
      - isKind:
          of: Application
      - hasDocuments:
          count: 1
      - documentSelector:
          path: metadata.name
          value: acm
        lengthEqual:
          path: spec.sources[1].helm.parameters
          count: 16
      - documentSelector:
          path: metadata.name
          value: acm
        contains:
          path: spec.sources[1].helm.parameters
          content:
            name: global.clusterGroupGitRepoUrl
            value: https://github.com/validatedpatterns/clustergroup-chart

  - it: should include clusterGroupChartGitRevision when set
    set:
      global:
        repoURL: https://github.com/validatedpatterns/multicloud-gitops
        multiSourceRepoUrl: https://charts.validatedpatterns.io
        clusterGroupChartGitRevision: v1.0.0
      clusterGroup:
        applications:
          acm:
            name: acm
            namespace: open-cluster-management
            project: hub
            chart: acm
            chartVersion: 0.1.*
    asserts:
      - isKind:
          of: Application
      - hasDocuments:
          count: 1
      - documentSelector:
          path: metadata.name
          value: acm
        lengthEqual:
          path: spec.sources[1].helm.parameters
          count: 16
      - documentSelector:
          path: metadata.name
          value: acm
        contains:
          path: spec.sources[1].helm.parameters
          content:
            name: global.clusterGroupChartGitRevision
            value: v1.0.0

  - it: should include both clustergroup git params when both are set
    set:
      global:
        repoURL: https://github.com/validatedpatterns/multicloud-gitops
        multiSourceRepoUrl: https://charts.validatedpatterns.io
        clusterGroupGitRepoUrl: https://github.com/validatedpatterns/clustergroup-chart
        clusterGroupChartGitRevision: main
      clusterGroup:
        applications:
          acm:
            name: acm
            namespace: open-cluster-management
            project: hub
            chart: acm
            chartVersion: 0.1.*
    asserts:
      - isKind:
          of: Application
      - hasDocuments:
          count: 1
      - documentSelector:
          path: metadata.name
          value: acm
        lengthEqual:
          path: spec.sources[1].helm.parameters
          count: 17
      - documentSelector:
          path: metadata.name
          value: acm
        contains:
          path: spec.sources[1].helm.parameters
          content:
            name: global.clusterGroupGitRepoUrl
            value: https://github.com/validatedpatterns/clustergroup-chart
      - documentSelector:
          path: metadata.name
          value: acm
        contains:
          path: spec.sources[1].helm.parameters
          content:
            name: global.clusterGroupChartGitRevision
            value: main
